#!/bin/bash

# ==============================================================================
# TYPE:      High-Intensity Network Auditor
# ORIGIN:    oxbv1 | 0xb0rn3
# GITHUB:    github.com/0xb0rn3/s3rp
# ==============================================================================

# --- CONSOLE COLORS ---
RED='\033[1;31m'
YEL='\033[1;33m'
GRN='\033[1;32m'
CYN='\033[0;36m'
WHT='\033[1;37m'
NC='\033[0m'

# --- ROOT CHECK ---
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}[!] CRITICAL: Root privileges required for raw socket access.${NC}"
   exit 1
fi

# --- BANNER ---
banner() {
    clear
    echo -e "${RED}"
    echo "   ██████  ██████  ██████  ██████  "
    echo "  ██      ░░    ██░░██  ██░░██  ██ "
    echo "   ██████  ██████  ░█████  ░█████  "
    echo "  ░░░░░██ ░░░░░░██ ░██░░██ ░██░░   "
    echo "   ██████  ██████  ░██ ░░██░██     "
    echo "  ░░░░░░  ░░░░░░   ░░   ░░ ░░      "
    echo -e "${WHT}   [ FULL SPECTRUM AUDIT WRAPPER ]${NC}"
    echo -e "${CYN}   [ TARGET: HARDENED INFRASTRUCTURE ]${NC}"
    echo "========================================"
}

# --- DEPENDENCY CHECK ---
check_deps() {
    local deps=("nmap" "xsltproc")
    for dep in "${deps[@]}"; do
        if ! command -v $dep &> /dev/null; then
            echo -e "${YEL}[!] Dependency '$dep' missing. Installing...${NC}"
            if [ -f /etc/debian_version ]; then
                apt-get update && apt-get install -y $dep
            elif [ -f /etc/arch-release ]; then
                pacman -S --noconfirm $dep
            else
                echo -e "${RED}[!] Manual install required for: $dep${NC}"
                exit 1
            fi
        fi
    done
}

# --- CONFIGURATION MODULE ---
configure_scan() {
    echo -e "\n${YEL}[+] SELECT INTENSITY PROFILE:${NC}"
    echo -e "${CYN}1.  Standard Audit${NC} (Service Detection, OS Fingerprint, Safe Scripts)"
    echo -e "${CYN}2.  Evasion/Stealth${NC} (Fragmented, Decoys, Source Port 53)"
    echo -e "${RED}3.  Active Intrusive${NC} (Vuln detection, Brute-force, Exploitation check)"
    echo -e "${RED}4.  Stress Test${NC} (Max Speed, Connection spam - DoS Risk)"
    
    read -p "Selection [1-4]: " mode

    # Default Target Prompt
    read -p "Enter Target IP/CIDR: " target
    [ -z "$target" ] && { echo -e "${RED}[!] Target required.${NC}"; exit 1; }

    # Setup Directory
    timestamp=$(date +%Y%m%d_%H%M%S)
    out_dir="s3rp_audit_${timestamp}"
    mkdir -p "$out_dir"
    
    case $mode in
        1)
            # Standard comprehensive
            FLAGS="-sS -sV -O --version-all -T4"
            SCRIPTS="--script=default,safe,discovery"
            ;;
        2)
            # Evasion Focus
            # -f: Fragment packets
            # -D: Decoys (RND:5 generates 5 random decoys)
            # --source-port 53: Simulate DNS traffic
            # --data-length: Append random data to packets
            FLAGS="-sS -f -D RND:5 --source-port 53 --data-length 25 -Pn -T3"
            SCRIPTS="--script=firewalk"
            ;;
        3)
            # Active/Intrusive (The "Aggressive" Request)
            # Uses 'exploit', 'vuln', 'brute' categories
            echo -e "${RED}[!] WARNING: This mode runs active exploitation/brute-force scripts.${NC}"
            echo -e "${RED}[!] Ensure you have written permission.${NC}"
            sleep 2
            FLAGS="-sS -sV --version-intensity 9 -O -T4"
            SCRIPTS="--script=vuln,exploit,auth,brute"
            ;;
        4)
            # Stress Test / Speed
            FLAGS="-sS -T5 --min-rate 1000 --max-retries 1 -n -Pn"
            SCRIPTS="--script=banner"
            ;;
        *)
            echo -e "${RED}[!] Invalid selection.${NC}"
            exit 1
            ;;
    esac

    run_nmap "$target" "$FLAGS" "$SCRIPTS" "$out_dir"
}

# --- EXECUTION ENGINE ---
run_nmap() {
    local tgt=$1
    local flg=$2
    local scr=$3
    local dir=$4
    local base="${dir}/scan"

    echo -e "\n${GRN}[+] ENGAGING TARGET: $tgt${NC}"
    echo -e "${CYN}[+] FLAGS: $flg${NC}"
    echo -e "${CYN}[+] SCRIPTS: $scr${NC}"
    echo -e "${YEL}[+] LOGGING TO: $dir${NC}\n"

    # Execute Nmap
    # Filter out standard noise, keep critical info
    nmap $flg $scr $tgt -oA "$base" --stats-every 10s \
    | grep -vE "Starting Nmap|Nmap done|tcpwrapped"

    # Post-Scan Analysis
    parse_results "$base.gnmap" "$base.xml"
}

# --- INTELLIGENCE PARSER ---
parse_results() {
    local gnmap=$1
    local xml=$2

    echo -e "\n${WHT}[+] AUDIT COMPLETE. GENERATING REPORT...${NC}"
    
    # Extract Open Ports & Services
    echo -e "\n${CYN}--- EXPOSED VECTORS ---${NC}"
    grep "Up" "$gnmap" | cut -d " " -f 2 | while read host; do
        echo -e "${GRN}HOST: $host${NC}"
        grep "$host" "$gnmap" | grep -oP '\d+/open/\w+//[^/]+/' | sed -e 's|/open/tcp//| : |' -e 's|/||g' | while read line; do
             echo -e "  -> $line"
        done
    done

    # Parse for Critical Vulnerabilities (from XML)
    if grep -q "VULNERABLE" "$xml"; then
        echo -e "\n${RED}[!] CRITICAL VULNERABILITIES DETECTED [!]${NC}"
        grep -B 2 -A 4 "VULNERABLE" "$xml" | sed 's/<[^>]*>//g' | awk '{$1=$1;print}'
    else
        echo -e "\n${GRN}[*] No obvious vulnerability flags in output.${NC}"
    fi

    echo -e "\n${YEL}[*] Full artifacts saved to output directory.${NC}"
}

# --- MAIN ---
check_deps
banner
configure_scan
