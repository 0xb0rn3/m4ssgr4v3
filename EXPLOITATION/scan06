#!/bin/bash

# ==============================================================================
# DEVELOPER: oxbv1 | 0xb0rn3
# GITHUB:    github.com/0xb0rn3/s3rp
# MISSION:   Anonymity, Discovery, and Automated Exploitation
# ==============================================================================

# --- COLORS ---
RED='\033[1;31m'
GRN='\033[1;32m'
CYN='\033[0;36m'
YEL='\033[1;33m'
WHT='\033[1;37m'
NC='\033[0m'

# --- BANNER ---
banner() {
    clear
    echo -e "${RED}"
    echo "  ███████╗██████╗ ██████╗ ██████╗ "
    echo "  ██╔════╝╚════██╗██╔══██╗██╔══██╗"
    echo "  ███████╗ █████╔╝██████╔╝██████╔╝"
    echo "  ╚════██║ ╚═══██╗██╔══██╗██╔═══╝ "
    echo "  ███████║██████╔╝██║  ██║██║     "
    echo "  ╚══════╝╚═════╝ ╚═╝  ╚═╝╚═╝     "
    echo -e "${WHT}   [ PERSISTENCE : ANONYMITY : EXPLOITATION ]${NC}"
    echo -e "${CYN}   [ DEV: oxbv1 | 0xb0rn3 ]${NC}"
    echo "==================================================="
}

# --- SYSTEM & PROXY CHECK ---
prep_environment() {
    if [[ $EUID -ne 0 ]]; then
       echo -e "${RED}[!] ROOT REQUIRED. RUN WITH SUDO.${NC}"
       exit 1
    fi

    echo -ne "${CYN}[*] Verifying ProxyChains... ${NC}"
    if command -v proxychains4 &> /dev/null; then
        echo -e "${GRN}[READY]${NC}"
        PC="proxychains4 -q"
    else
        echo -e "${RED}[MISSING]${NC}"
        PC=""
    fi
}

# --- TARGET & MODE CONFIGURATION ---
configure_op() {
    echo -e "\n${YEL}[+] TARGET ACQUISITION:${NC}"
    read -p ">> IP / CIDR / URL: " TARGET
    [ -z "$TARGET" ] && exit 1

    SESSION_DIR="s3rp_OP_$(date +%H%M%S)"
    mkdir -p "$SESSION_DIR"
    OUT_BASE="$SESSION_DIR/s3rp_results"

    echo -e "\n${YEL}[+] SELECT ENGAGEMENT PROFILE:${NC}"
    echo -e "1. ${CYN}Ghost Mode${NC} (Stealth, Fragmentation, Decoys, MTU 16)"
    echo -e "2. ${RED}Exploit Hunter${NC} (Aggressive Scripts, Brute-force, Vuln Scan)"
    echo -e "3. ${WHT}Total War${NC} (Full Port Sweep, OS Intrusive, All Scripts)"
    read -p ">> Selection: " MODE

    case $MODE in
        1) FLAGS="-sS -Pn -f --mtu 16 -g 53 -D RND:10 --data-length 32 -T2"
           NSE="--script=banner" ;;
        2) FLAGS="-sV --version-all --reason -Pn -T4"
           NSE="--script=vuln,exploit,auth,brute" ;;
        3) FLAGS="-p- -A -sV -Pn -T4"
           NSE="--script=default,safe,vuln,exploit" ;;
    esac
}

# --- THE EXECUTION ENGINE ---
execute_recon() {
    echo -e "\n${RED}[!] LAUNCHING ATTACK THROUGH PROXYCHAINS...${NC}"
    
    # Execute Nmap, strip noise, save all formats
    $PC nmap $FLAGS $NSE $TARGET -oA "$OUT_BASE" --stats-every 10s | \
    grep -vE "Starting Nmap|Nmap done|tcpwrapped"

    # Convert XML to HTML for the visual report
    if command -v xsltproc &> /dev/null; then
        xsltproc "${OUT_BASE}.xml" -o "${OUT_BASE}.html" 2>/dev/null
    fi
}

# --- EXPLOIT AUTOMATION MODULE ---
automate_exploit() {
    echo -e "\n${YEL}[+] CROSS-REFERENCING EXPLOIT-DB...${NC}"
    searchsploit --nmap "${OUT_BASE}.xml" > "${SESSION_DIR}/exploit_matches.txt"
    
    # Generate Metasploit Resource Script (.rc)
    RC_FILE="${SESSION_DIR}/s3rp_msf_launch.rc"
    echo -e "${YEL}[+] BUILDING METASPLOIT RESOURCE SCRIPT...${NC}"
    
    {
        echo "spool ${SESSION_DIR}/msf_session.log"
        echo "workspace -a s3rp_redteam"
        echo "db_import ${OUT_BASE}.xml"
        echo "hosts"
        echo "services"
        echo "# --- Identified Exploit Vectors ---"
        
        # Extract potential MSF modules from searchsploit results
        grep "exploits/remote/" "${SESSION_DIR}/exploit_matches.txt" | awk '{print "# use " $NF}' >> "$RC_FILE"
        
        echo "# Run 'vulns' to see service vulnerabilities"
    } > "$RC_FILE"

    # Identify any Ruby files that can be directly used
    echo -e "${GRN}[+] Exploit mapping completed.${NC}"
}

# --- FINAL OUTPUT ---
show_summary() {
    echo -e "\n${WHT}===================================================${NC}"
    echo -e "${RED}s3rp OPERATION SUMMARY${NC}"
    echo -e "---------------------------------------------------"
    echo -e "Intel Directory: ${CYN}$SESSION_DIR${NC}"
    echo -e "Visual Report:   ${CYN}${OUT_BASE}.html${NC}"
    echo -e "Searchsploit:    ${CYN}${SESSION_DIR}/exploit_matches.txt${NC}"
    echo -e "Metasploit RC:   ${CYN}${RC_FILE}${NC}"
    echo -e "---------------------------------------------------"
    echo -e "${YEL}TO LAUNCH EXPLOITATION PHASE:${NC}"
    echo -e "${WHT}msfconsole -r $RC_FILE${NC}"
    echo -e "===================================================${NC}"
}

# --- START ---
banner
prep_environment
configure_op
execute_recon
automate_exploit
show_summary
