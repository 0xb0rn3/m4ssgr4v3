#!/bin/bash

# ==============================================================================
# DEVELOPER: oxbv1 | 0xb0rn3
# GITHUB:    github.com/0xb0rn3/s3rp
#    Advanced Recon, Evasion, and Automated Exploit Mapping
# ==============================================================================

# --- UI ELEMENTS ---
RED='\033[1;31m'
GRN='\033[1;32m'
CYN='\033[0;36m'
YEL='\033[1;33m'
WHT='\033[1;37m'
NC='\033[0m'

# --- BANNER (SILENCING NMAP NOISE) ---
banner() {
    clear
    echo -e "${RED}"
    echo "  ███████╗██████╗ ██████╗ ██████╗ "
    echo "  ██╔════╝╚════██╗██╔══██╗██╔══██╗"
    echo "  ███████╗ █████╔╝██████╔╝██████╔╝"
    echo "  ╚════██║ ╚═══██╗██╔══██╗██╔═══╝ "
    echo "  ███████║██████╔╝██║  ██║██║     "
    echo "  ╚══════╝╚═════╝ ╚═╝  ╚═╝╚═╝     "
    echo -e "${WHT}  [ RED TEAM TACTICAL INTERFACE ]${NC}"
    echo -e "${CYN}  [ INTEGRATION: NMAP + SEARCHSPLOIT ]${NC}"
    echo "==================================================="
}

# --- DEPENDENCY VALIDATION ---
check_env() {
    local tools=("nmap" "searchsploit" "xsltproc")
    for tool in "${tools[@]}"; do
        if ! command -v $tool &> /dev/null; then
            echo -e "${YEL}[!] Warning: $tool is not installed.${NC}"
            read -p "Attempt auto-install? (y/n): " confirm
            if [[ $confirm == "y" ]]; then
                sudo apt-get update && sudo apt-get install -y $tool
            fi
        fi
    done
}

# --- TACTICAL SELECTION ---
get_config() {
    echo -e "\n${YEL}[+] TARGET ACQUISITION:${NC}"
    read -p ">> Enter Target(s) (IP/CIDR/URL): " TARGET
    [ -z "$TARGET" ] && exit 1

    echo -e "\n${YEL}[+] OPERATION PROFILE:${NC}"
    echo -e "1. ${CYN}Ghost Recon${NC} (Bypass FW, Fragmentation, MTU 8, Decoys)"
    echo -e "2. ${CYN}Service Vulnerability Audit${NC} (Banner Grab + Vuln NSE)"
    echo -e "3. ${RED}Active Engagement${NC} (Brute, Exploit, Intrusive NSE)"
    echo -e "4. ${RED}The 'Kitchen Sink'${NC} (All Ports, All Scripts, Aggressive)"
    read -p "Select [1-4]: " OP_MODE

    # Output Management
    SESSION_DIR="s3rp_log_$(date +%H%M%S)"
    mkdir -p "$SESSION_DIR"
    OUT_BASE="$SESSION_DIR/redteam_scan"

    case $OP_MODE in
        1) # EVASION
           # -f: Fragment; -D: Decoy IPs; -g: Source Port; --data-length: Padding
           FLAGS="-sS -Pn -f --mtu 8 -g 53 -D RND:10 --data-length 25 -T2"
           NSE="--script=banner,firewalk"
           ;;
        2) # VULN AUDIT
           FLAGS="-sV --version-all -O -Pn -T4"
           NSE="--script=vuln,vulners"
           ;;
        3) # ACTIVE ATTACK
           FLAGS="-sV -O -Pn -T4"
           NSE="--script=exploit,auth,brute"
           ;;
        4) # KITCHEN SINK
           FLAGS="-p- -A -sV -sC -T4"
           NSE="--script=vuln,exploit,auth,brute,default"
           ;;
    esac
}

# --- EXECUTION ENGINE ---
run_op() {
    echo -e "\n${RED}[!] INITIATING SCAN...${NC}"
    
    # Run Nmap and strip banners
    # Using -oA to generate all formats (XML is needed for Searchsploit)
    nmap $FLAGS $NSE $TARGET -oA "$OUT_BASE" --stats-every 10s | \
    grep -vE "Starting Nmap|Nmap done|tcpwrapped"

    echo -e "\n${GRN}[+] SCAN PHASE COMPLETE.${NC}"
}

# --- SEARCHSPLOIT INTEGRATION ---
map_exploits() {
    local XML_FILE="${OUT_BASE}.xml"
    echo -e "\n${YEL}[+] INTEGRATING SEARCHSPLOIT INTEL...${NC}"
    echo "---------------------------------------------------"
    
    if [ ! -f "$XML_FILE" ]; then
        echo -e "${RED}[!] XML data missing. Cannot map exploits.${NC}"
        return
    fi

    # Use Searchsploit to read the Nmap XML and find matching exploits
    # --nmap: Reads Nmap XML output
    searchsploit --nmap "$XML_FILE" > "${SESSION_DIR}/mapped_exploits.txt"

    if [ -s "${SESSION_DIR}/mapped_exploits.txt" ]; then
        echo -e "${GRN}[!] EXPLOITABLE VECTORS FOUND:${NC}"
        cat "${SESSION_DIR}/mapped_exploits.txt"
    else
        echo -e "${CYN}[*] No direct public exploits found for identified versions.${NC}"
    fi
}

# --- FINAL REPORTING ---
finalize() {
    echo -e "\n${YEL}[+] FINALIZING REPORT...${NC}"
    
    # Create HTML report from XML for visual analysis
    xsltproc "${OUT_BASE}.xml" -o "${OUT_BASE}.html" 2>/dev/null

    echo -e "==================================================="
    echo -e "${GRN}OP SUCCESSFUL.${NC}"
    echo -e "HTML Report:   ${WHT}${OUT_BASE}.html${NC}"
    echo -e "Exploit List:  ${WHT}${SESSION_DIR}/mapped_exploits.txt${NC}"
    echo -e "Raw Logs:      ${WHT}${SESSION_DIR}/${NC}"
    echo "==================================================="
}

# --- ENTRY POINT ---
check_env
banner
get_config
run_op
map_exploits
finalize
