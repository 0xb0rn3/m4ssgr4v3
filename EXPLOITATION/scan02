#!/bin/bash

# ==============================================================================
# ARCHITECT: oxbv1 | 0xb0rn3
# GITHUB:    github.com/0xb0rn3/s3rp
# ==============================================================================

# --- VISUAL WARFARE ---
RED='\033[1;31m'
BLOOD='\033[0;31m'
GREEN='\033[1;32m'
DARK_GREY='\033[1;30m'
CYAN='\033[0;36m'
NC='\033[0m'

trap "echo -e '${RED}[!] ABORTING. COVER YOUR TRACKS.${NC}'; exit 1" INT

banner() {
    clear
    echo -e "${BLOOD}"
    echo "   (                                 "
    echo "   )\ )               )              "
    echo "  (()/(   (    (   ( /(   (      )   "
    echo "   /(_)) ))\   )(  )\())  )(  ( /(   "
    echo "  (_))  /((_) (()\((_)\  (()\ )(_))  "
    echo "  / __|(_))    ((_) \(_)  ((_)((_)_  "
    echo "  \__ \/ -_)  | '_| ' \  / _ \/ _ \  "
    echo "  |___/\___|  |_| |_||_| \___/\___/  "
    echo -e "${RED}      [ SYSTEM: ONLINE | MODE: HOSTILE ]${NC}"
    echo -e "${DARK_GREY}      [ DEV: oxbv1 | 0xb0rn3 ]${NC}"
    echo "==================================================="
}

# --- THE ARMORY (Check Tools) ---
check_weapons() {
    if ! command -v nmap &> /dev/null; then
        echo -e "${RED}[!] Nmap is missing. You are unarmed.${NC}"
        echo -e "${CYAN}[*] Forcing installation...${NC}"
        sudo apt-get install -y nmap || { echo -e "${RED}[!] Failed. You are on your own."; exit 1; }
    fi
}

# --- TARGET ACQUISITION ---
acquire_target() {
    echo -e "\n${CYAN}[+] DEFINE THE OBJECTIVE:${NC}"
    echo -e "1. Single Host (Precision Strike)"
    echo -e "2. Subnet (Carpet Bombing - /24)"
    echo -e "3. List File (The Hitlist)"
    echo -n "Select >> "
    read choice

    case $choice in
        1|2)
            echo -n "Enter IP/CIDR >> "
            read TARGET
            ;;
        3)
            echo -n "Path to list >> "
            read listfile
            [ ! -f "$listfile" ] && { echo -e "${RED}[!] File ghosted. Exiting.${NC}"; exit 1; }
            TARGET="-iL $listfile"
            ;;
        *) TARGET="" ;;
    esac
    
    # OUTPUT STRUCTURE
    SESSION_ID="s3rp_OP_$(date +%F_%H-%M)"
    mkdir -p "$SESSION_ID"
    echo -e "${GREEN}[*] Intel storage initialized: $SESSION_ID${NC}"
}

# --- TACTICAL CONFIGURATION ---
# This is where we break the rules.
configure_tactics() {
    echo -e "\n${CYAN}[+] SELECT ENGAGEMENT RULES:${NC}"
    echo -e "${RED}1. STEALTH/EVASION${NC} (Fragment packets, decoys, source port manipulation)"
    echo -e "${RED}2. NOISE/SHOCK${NC} (Insane speed, T5, max retries)"
    echo -e "${RED}3. DEEP DIVE${NC} (All ports, versions, OS, traceroute)"
    echo -e "${RED}4. VULNERABILITY HUNT${NC} (Vulners, ExploitDB, Auth)"
    echo -e "${RED}5. CUSTOM WARFARE${NC} (Manual flags)"
    echo -n "Strategy >> "
    read strategy

    case $strategy in
        1)
            # FIREWALL BYPASS MODE
            # -f: Fragment packets
            # -D: Decoys (Hide among random IPs)
            # --source-port: Mimic DNS traffic (53)
            # -g 53: Source port 53
            echo -e "${GREEN}[*] Loading Cloaking Protocols...${NC}"
            FLAGS="-sS -f -g 53 --mtu 24 -n -Pn --data-length 15"
            NSE="--script=firewalk,firewall-bypass"
            ;;
        2)
            # LOUD AND FAST
            echo -e "${RED}[*] Safety limits disabled. Burning the wire.${NC}"
            FLAGS="-n -Pn -sS -T5 --min-rate 2000 --max-retries 2"
            NSE="--script=banner"
            ;;
        3)
            # FULL RECON
            echo -e "${CYAN}[*] Initiating full spectrum analysis...${NC}"
            FLAGS="-p- -sS -sV -O --version-intensity 9 --osscan-guess -A -T4"
            NSE="--script=default,discovery,safe"
            ;;
        4)
            # VULN SCAN (THE KILL SHOT)
            echo -e "${BLOOD}[*] Loading vulnerability databases...${NC}"
            FLAGS="-sV --version-all"
            # Attempt to use vulners if installed, else fallback to vuln
            NSE="--script=vuln,auth,vulners"
            ;;
        5)
            echo -n "Enter manual Nmap flags >> "
            read FLAGS
            NSE=""
            ;;
        *)
            FLAGS="-sS -sV"
            ;;
    esac
}

# --- THE EXECUTIONER ---
execute_scan() {
    OUTFILE="$SESSION_ID/scan"
    
    echo -e "\n${RED}[!] LOCKING ON TARGET: $TARGET${NC}"
    echo -e "${CYAN}[*] Vector: $FLAGS $NSE${NC}"
    echo -e "${BLOOD}[!] ENGAGING... (DO NOT INTERRUPT)${NC}\n"

    # THE COMMAND
    # We strip the banner because you hate noise.
    # We filter 'tcpwrapped' because it's a lie.
    sudo nmap $FLAGS $NSE $TARGET \
        -oN "${OUTFILE}.txt" \
        -oG "${OUTFILE}.gnmap" \
        -oX "${OUTFILE}.xml" \
        --stats-every 5s \
        | grep -vE "^Starting Nmap|^Nmap done|tcpwrapped" 

    echo -e "\n${GREEN}[+] Scan Cycle Complete.${NC}"
    
    # INTELLIGENCE PARSING
    # We don't just dump text. We extract value.
    echo -e "\n${CYAN}[+] EXTRACTING ACTIONABLE INTEL...${NC}"
    
    # Parse the GNMAP for a clean IP:PORT list
    echo -e "${DARK_GREY}--- OPEN VECTORS ---${NC}"
    grep "Up" "${OUTFILE}.gnmap" | cut -d " " -f 2 | while read host; do
        echo -e "${RED}TARGET: $host${NC}"
        # Extract ports and services cleanly
        grep "$host" "${OUTFILE}.gnmap" | grep -oP '\d+/open/\w+//[^/]+/' | sed -e 's|/open/tcp//| : |' -e 's|/||g' | while read port; do
            echo -e "  -> $port"
        done
    done
    
    echo -e "\n${GREEN}[*] Full intel dumped to: $SESSION_ID/${NC}"
    echo -e "${GREEN}[*] s3rp is watching.${NC}"
}

# --- MAIN LOOP ---
check_weapons
banner
acquire_target
configure_tactics
execute_scan

# End with a hook for the next step
echo -e "\n${RED}Analysis complete. The network is exposed.${NC}"
echo -e "If you found HTTP services, I can launch a dedicated directory brute-forcer next."
