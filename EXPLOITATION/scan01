#!/bin/bash
# ==============================================================================
# Description: Advanced Nmap Wrapper with NSE integration, concurrency, and 
#              menu-driven customization.
# ==============================================================================

# --- Colors for UI ---
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- Global Variables ---
TARGET=""
OUTPUT_DIR="s3rp_scans_$(date +%Y%m%d_%H%M%S)"
SCAN_FLAGS=""
NSE_FLAGS=""
TIMING="-T4"

# --- Trap for Ctrl+C ---
trap ctrl_c INT
function ctrl_c() {
    echo -e "\n${RED}[!] Exiting s3rp...${NC}"
    exit 1
}

# --- Header Function ---
show_banner() {
    clear
    echo -e "${GREEN}"
    echo "   _____ ____               "
    echo "  / ___/|___ \ _ __ _ __    "
    echo "  \___ \  __) | '__| '_ \   "
    echo "   ___) |/ __/| |  | |_) |  "
    echo "  |____/|_____|_|  | .__/   "
    echo "                   | |      "
    echo "                   |_|      "
    echo -e "${NC}"
    echo -e "${CYAN}  :: s3rp :: Advanced Nmap Wrapper${NC}"
    echo -e "${CYAN}  :: Dev  :: oxbv1 | 0xb0rn3${NC}"
    echo -e "${CYAN}  :: Repo :: github.com/0xb0rn3/s3rp${NC}"
    echo "==================================================="
}

# --- Dependency Check & Installation ---
check_deps() {
    if ! command -v nmap &> /dev/null; then
        echo -e "${YELLOW}[!] Nmap not found.${NC}"
        echo -e "${BLUE}[*] Attempting to install Nmap...${NC}"
        
        if [ -f /etc/debian_version ]; then
            sudo apt-get update && sudo apt-get install -y nmap
        elif [ -f /etc/redhat-release ]; then
            sudo dnf install -y nmap
        elif [ -f /etc/arch-release ]; then
            sudo pacman -S --noconfirm nmap
        else
            echo -e "${RED}[!] OS not supported for auto-install. Please install nmap manually.${NC}"
            exit 1
        fi
        
        if ! command -v nmap &> /dev/null; then
             echo -e "${RED}[!] Installation failed. Exiting.${NC}"
             exit 1
        fi
        echo -e "${GREEN}[+] Nmap installed successfully.${NC}"
        sleep 2
    fi
}

# --- Target Selection ---
set_target() {
    echo -e "\n${YELLOW}[?] Target Selection:${NC}"
    echo "1. Single IP/URL (e.g., 192.168.1.1 or example.com)"
    echo "2. Network Range (CIDR) (e.g., 192.168.1.0/24)"
    echo "3. Import from List (File)"
    read -p "Select option [1-3]: " t_opt

    case $t_opt in
        1|2)
            read -p "Enter Target IP/URL/CIDR: " TARGET
            ;;
        3)
            read -p "Enter path to file: " list_file
            if [ -f "$list_file" ]; then
                TARGET="-iL $list_file"
            else
                echo -e "${RED}[!] File not found!${NC}"
                set_target
            fi
            ;;
        *)
            echo -e "${RED}[!] Invalid option.${NC}"
            set_target
            ;;
    esac
}

# --- NSE Configuration ---
config_nse() {
    echo -e "\n${YELLOW}[?] Nmap Scripting Engine (NSE) Configuration:${NC}"
    echo "1. Default Safe Scripts (-sC)"
    echo "2. Vulnerability Detection (vuln)"
    echo "3. Discovery & Safe (discovery,safe)"
    echo "4. HTTP Enumeration (http-enum, http-title, etc)"
    echo "5. Custom Script Arguments"
    echo "6. Skip NSE"
    read -p "Select option [1-6]: " nse_opt

    case $nse_opt in
        1) NSE_FLAGS="-sC" ;;
        2) NSE_FLAGS="--script=vuln" ;;
        3) NSE_FLAGS="--script=discovery,safe" ;;
        4) NSE_FLAGS="--script=http-title,http-server-header,http-methods,http-headers" ;;
        5) 
            read -p "Enter specific script names (comma separated): " custom_scripts
            NSE_FLAGS="--script=$custom_scripts" 
            ;;
        6) NSE_FLAGS="" ;;
        *) echo -e "${RED}[!] Invalid. Skipping NSE.${NC}"; NSE_FLAGS="" ;;
    esac
}

# --- Advanced Options ---
config_advanced() {
    echo -e "\n${YELLOW}[?] Advanced Customization:${NC}"
    
    # Timing
    read -p "Set Timing Template (0-5) [Default 4]: " t_val
    if [[ "$t_val" =~ ^[0-5]$ ]]; then
        TIMING="-T$t_val"
    else
        TIMING="-T4"
    fi

    # Scan Flags
    echo "1. TCP SYN Scan (Stealth) [-sS]"
    echo "2. TCP Connect Scan [-sT]"
    echo "3. UDP Scan [-sU]"
    echo "4. Comprehensive (SYN + Version + OS) [-sS -sV -O]"
    echo "5. Custom Flags"
    read -p "Select Scan Type [1-5]: " type_opt

    case $type_opt in
        1) SCAN_FLAGS="-sS" ;;
        2) SCAN_FLAGS="-sT" ;;
        3) SCAN_FLAGS="-sU" ;;
        4) SCAN_FLAGS="-sS -sV -O --version-all" ;;
        5) read -p "Enter custom flags (e.g., -sA -f): " cust_f; SCAN_FLAGS="$cust_f" ;;
        *) SCAN_FLAGS="-sS" ;;
    esac

    # Filter/Grep Options
    echo -e "${BLUE}[i] Applying banner filter and formatted output...${NC}"
}

# --- Execution ---
run_scan() {
    # Ensure output directory exists
    mkdir -p "$OUTPUT_DIR"
    
    echo -e "\n${CYAN}[*] Initializing s3rp scan...${NC}"
    echo -e "${CYAN}[*] Target: $TARGET${NC}"
    echo -e "${CYAN}[*] Output Directory: $OUTPUT_DIR${NC}"
    
    # Construct Command
    # -n: No DNS resolution (speed)
    # -Pn: Treat hosts as online (skip ping)
    # --open: Show only open ports
    # --stats-every: Progress indication
    # --min-rate: Concurrency boost
    
    BASE_CMD="nmap -n -Pn --open --stats-every 10s --min-rate 500 $TIMING $SCAN_FLAGS $NSE_FLAGS $TARGET"
    
    OUTPUT_FILE="$OUTPUT_DIR/scan_results.txt"
    GNMAP_FILE="$OUTPUT_DIR/scan_results.gnmap"
    XML_FILE="$OUTPUT_DIR/scan_results.xml"

    echo -e "${YELLOW}[>] Executing: $BASE_CMD${NC}\n"

    # Execute and filter standard Nmap header, save to formats
    # filtering 'Starting Nmap' banner as requested
    $BASE_CMD -oN "$OUTPUT_FILE" -oG "$GNMAP_FILE" -oX "$XML_FILE" | grep -v "Starting Nmap" | grep -v "Nmap done"
    
    echo -e "\n${GREEN}[+] Scan Complete.${NC}"
    echo -e "${GREEN}[+] Results saved to $OUTPUT_DIR${NC}"
    
    # Optional: Quick parsing of the grepable output for immediate view
    echo -e "\n${CYAN}[*] Quick Summary (Open Ports):${NC}"
    grep "Up" "$GNMAP_FILE" | cut -d " " -f 2 | while read -r ip; do
        ports=$(grep "$ip" "$GNMAP_FILE" | grep "Ports:" | sed 's/.*Ports: //')
        echo -e "${GREEN}$ip${NC} => $ports"
    done
}

# --- Main Logic ---
check_deps
show_banner

# Main Menu
PS3="Select an action: "
options=("Configure & Scan" "Quick Recon (Banner Grab)" "Full Audit (All Ports + Vuln)" "Exit")
select opt in "${options[@]}"
do
    case $opt in
        "Configure & Scan")
            set_target
            config_advanced
            config_nse
            run_scan
            break
            ;;
        "Quick Recon (Banner Grab)")
            set_target
            SCAN_FLAGS="-sS -sV --version-intensity 5"
            NSE_FLAGS="--script=banner"
            TIMING="-T4"
            run_scan
            break
            ;;
        "Full Audit (All Ports + Vuln)")
            set_target
            SCAN_FLAGS="-p- -sS -sV -O"
            NSE_FLAGS="--script=vuln,safe"
            TIMING="-T4"
            run_scan
            break
            ;;
        "Exit")
            exit 0
            ;;
        *) echo "Invalid option $REPLY";;
    esac
done
