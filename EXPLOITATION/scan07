#!/bin/bash

# ==============================================================================
# DEVELOPER: oxbv1 | 0xb0rn3
# MISSION:   Anonymized Recon, Exploit Mapping, and Web Content Discovery
# ==============================================================================

# --- COLORS ---
RED='\033[1;31m'
GRN='\033[1;32m'
CYN='\033[0;36m'
YEL='\033[1;33m'
WHT='\033[1;37m'
NC='\033[0m'

# --- BANNER ---
banner() {
    clear
    echo -e "${RED}"
    echo "  ███████╗██████╗ ██████╗ ██████╗ "
    echo "  ██╔════╝╚════██╗██╔══██╗██╔══██╗"
    echo "  ███████╗ █████╔╝██████╔╝██████╔╝"
    echo "  ╚════██║ ╚═══██╗██╔══██╗██╔═══╝ "
    echo "  ███████║██████╔╝██║  ██║██║     "
    echo "  ╚══════╝╚═════╝ ╚═╝  ╚═╝╚═╝     "
    echo -e "${WHT}   [ APEX OPERATIONAL ORCHESTRATOR ]${NC}"
    echo "==================================================="
}

# --- SYSTEM CHECK ---
prep_environment() {
    [[ $EUID -ne 0 ]] && { echo -e "${RED}[!] ROOT REQUIRED.${NC}"; exit 1; }

    echo -ne "${CYN}[*] Checking ProxyChains... ${NC}"
    if command -v proxychains4 &> /dev/null; then
        echo -e "${GRN}[READY]${NC}"
        PC="proxychains4 -q"
    else
        echo -e "${RED}[MISSING]${NC}"
        PC=""
    fi
}

# --- CONFIGURATION ---
configure_op() {
    echo -e "\n${YEL}[+] TARGET ACQUISITION:${NC}"
    read -p ">> IP / CIDR / URL: " TARGET
    [ -z "$TARGET" ] && exit 1

    SESSION_DIR="s3rp_OP_$(date +%H%M%S)"
    mkdir -p "$SESSION_DIR/web_discovery"
    OUT_BASE="$SESSION_DIR/s3rp_results"

    echo -e "\n${YEL}[+] CHOOSE OPERATIONAL PROFILE:${NC}"
    echo -e "1. ${CYN}Stealth Recon${NC} (Evasion, Fragments, Decoys)"
    echo -e "2. ${RED}Exploit Striker${NC} (NSE Exploit + Brute-force)"
    echo -e "3. ${WHT}Total Infrastructure War${NC} (p-, All Scripts, All Ports)"
    read -p ">> Selection: " MODE

    case $MODE in
        1) FLAGS="-sS -Pn -f --mtu 16 -g 53 -D RND:10 -T2" ;;
        2) FLAGS="-sV --version-all -Pn -T4 --script=vuln,exploit,auth,brute" ;;
        3) FLAGS="-p- -A -sV -Pn -T4 --script=vuln,exploit,default" ;;
    esac
}

# --- RECON & WEB DISCOVERY ---
execute_attack() {
    echo -e "\n${RED}[!] ENGAGING TARGET VIA $PC...${NC}"
    $PC nmap $FLAGS $TARGET -oA "$OUT_BASE" --stats-every 10s | grep -v "Starting"

    # GOBSTER INTEGRATION (Triggered on web ports)
    echo -e "\n${YEL}[+] SCANNING FOR WEB VECTORS (Ports 80, 443, 8080)...${NC}"
    grep -E "80/open|443/open|8080/open" "${OUT_BASE}.nmap" | while read -r line; do
        PORT=$(echo $line | cut -d'/' -f1)
        PROTO=$( [[ "$PORT" == "443" ]] && echo "https" || echo "http" )
        URL="${PROTO}://${TARGET}:${PORT}"
        
        echo -e "${CYN}[*] Launching Gobuster on: $URL${NC}"
        # -k skips TLS cert verification for HTTPS
        $PC gobuster dir -u "$URL" -w /usr/share/wordlists/dirb/common.txt -t 50 -k -o "$SESSION_DIR/web_discovery/port_${PORT}.txt" -q
    done
}

# --- MSF & SEARCHSPLOIT LINKING ---
generate_intel() {
    echo -e "\n${YEL}[+] CROSS-REFERENCING EXPLOIT-DB...${NC}"
    searchsploit --nmap "${OUT_BASE}.xml" > "${SESSION_DIR}/exploit_matches.txt"
    
    RC_FILE="${SESSION_DIR}/s3rp_launch.rc"
    {
        echo "workspace -a s3rp_redteam"
        echo "db_import ${OUT_BASE}.xml"
        echo "hosts"
        echo "# --- RECOMMENDED MSF MODULES ---"
        grep "exploits/remote/" "${SESSION_DIR}/exploit_matches.txt" | awk '{print "# use exploit" substr($NF, index($NF, "/"))}' | sed 's/\.rb//' >> "$RC_FILE"
    } > "$RC_FILE"
}

# --- FINAL REPORT ---
finalize() {
    [ -f "${OUT_BASE}.xml" ] && command -v xsltproc &>/dev/null && xsltproc "${OUT_BASE}.xml" -o "${OUT_BASE}.html"
    
    echo -e "\n${WHT}===================================================${NC}"
    echo -e "${RED}s3rp OPERATION COMPLETE${NC}"
    echo -e "---------------------------------------------------"
    echo -e "1. Visual Report:   ${CYN}${OUT_BASE}.html${NC}"
    echo -e "2. Web Directories: ${CYN}${SESSION_DIR}/web_discovery/${NC}"
    echo -e "3. Fire Metasploit: ${WHT}msfconsole -r $RC_FILE${NC}"
    echo -e "===================================================${NC}"
}

# --- RUN ---
banner
prep_environment
configure_op
execute_attack
generate_intel
finalize
