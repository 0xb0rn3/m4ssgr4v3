#!/bin/bash

# ==============================================================================
# DEVELOPER: oxbv1 | 0xb0rn3
# GITHUB:    github.com/0xb0rn3/s3rp
# FEATURES:  ProxyChains, Nmap Evasion, Searchsploit, Metasploit RC Generation
# ==============================================================================

# --- UI COLORS ---
RED='\033[1;31m'
GRN='\033[1;32m'
CYN='\033[0;36m'
YEL='\033[1;33m'
WHT='\033[1;37m'
NC='\033[0m'

# --- BANNER ---
banner() {
    clear
    echo -e "${RED}"
    echo "  ███████╗██████╗ ██████╗ ██████╗ "
    echo "  ██╔════╝╚════██╗██╔══██╗██╔══██╗"
    echo "  ███████╗ █████╔╝██████╔╝██████╔╝"
    echo "  ╚════██║ ╚═══██╗██╔══██╗██╔═══╝ "
    echo "  ███████║██████╔╝██║  ██║██║     "
    echo "  ╚══════╝╚═════╝ ╚═╝  ╚═╝╚═╝     "
    echo -e "${WHT}  [ PERSISTENCE : ANONYMITY : EXPLOITATION ]${NC}"
    echo "==================================================="
}

# --- DEPENDENCY & PROXY CHECK ---
check_system() {
    local tools=("nmap" "searchsploit" "msfconsole" "proxychains4")
    for tool in "${tools[@]}"; do
        if ! command -v $tool &> /dev/null; then
            echo -e "${YEL}[!] Warning: $tool not found. Install for full power.${NC}"
        fi
    done

    # Check ProxyChains
    echo -ne "${CYN}[*] Checking ProxyChains status... ${NC}"
    if [ -f /etc/proxychains4.conf ]; then
        echo -e "${GRN}[ACTIVE]${NC}"
        PC="proxychains4 -q"
    else
        echo -e "${RED}[MISSING]${NC}"
        echo -e "${YEL}[!] Running without proxy layer!${NC}"
        PC=""
    fi
}

# --- CONFIGURATION ---
get_target() {
    echo -e "\n${YEL}[+] TARGETING:${NC}"
    read -p ">> IP / CIDR / URL: " TARGET
    [ -z "$TARGET" ] && exit 1

    SESSION_DIR="s3rp_OP_$(date +%H%M%S)"
    mkdir -p "$SESSION_DIR"
    OUT_BASE="$SESSION_DIR/s3rp_scan"
    
    echo -e "\n${YEL}[+] CHOOSE ATTACK VECTOR:${NC}"
    echo -e "1. ${CYN}Stealth Recon${NC} (Bypass IDS/FW, Decoys, Fragmentation)"
    echo -e "2. ${RED}Vulnerability Strike${NC} (Aggressive Scripts + Brute-force)"
    echo -e "3. ${WHT}Full Infrastructure Audit${NC} (All Ports + OS Fingerprinting)"
    read -p ">> Selection: " MODE

    case $MODE in
        1) FLAGS="-sS -Pn -f --mtu 16 -g 53 -D RND:5 -T2"
           NSE="--script=banner" ;;
        2) FLAGS="-sV --version-all -Pn -T4"
           NSE="--script=vuln,exploit,auth,brute" ;;
        3) FLAGS="-p- -A -sV -Pn -T4"
           NSE="--script=default,safe" ;;
    esac
}

# --- EXECUTION ENGINE ---
run_scan() {
    echo -e "\n${RED}[!] ENGAGING TARGET THROUGH PROXYCHAINS...${NC}"
    
    # Execute Nmap through ProxyChains
    $PC nmap $FLAGS $NSE $TARGET -oA "$OUT_BASE" --stats-every 10s | \
    grep -vE "Starting Nmap|Nmap done|tcpwrapped"

    echo -e "\n${GRN}[+] SCAN COMPLETE. Intel stored in $SESSION_DIR${NC}"
}

# --- SEARCHSPLOIT & METASPLOIT INTEGRATION ---
generate_exploits() {
    echo -e "\n${YEL}[+] CROSS-REFERENCING EXPLOIT-DB...${NC}"
    searchsploit --nmap "${OUT_BASE}.xml" > "${SESSION_DIR}/exploits.txt"
    
    # Generate Metasploit Resource Script (.rc)
    # This automates the MSF side: workspace, database import, and host setting
    RC_FILE="${SESSION_DIR}/s3rp_msf_setup.rc"
    echo -e "\n${YEL}[+] GENERATING METASPLOIT RESOURCE SCRIPT...${NC}"
    
    {
        echo "spool ${SESSION_DIR}/msf_console.log"
        echo "workspace -a s3rp_audit"
        echo "db_import ${OUT_BASE}.xml"
        echo "hosts"
        echo "services"
        echo "# Suggested Exploits Below (Manual verification required):"
        grep "Exploit Title" "${SESSION_DIR}/exploits.txt" | awk '{print "# " $0}'
    } > "$RC_FILE"

    echo -e "${GRN}[+] Resource script created: $RC_FILE${NC}"
}

# --- FINAL REPORT ---
finalize() {
    # Generate HTML for the human eye
    if command -v xsltproc &> /dev/null; then
        xsltproc "${OUT_BASE}.xml" -o "${OUT_BASE}.html" 2>/dev/null
    fi

    echo -e "\n${WHT}===================================================${NC}"
    echo -e "${RED}s3rp MISSION COMPLETE${NC}"
    echo -e "---------------------------------------------------"
    echo -e "1. Run ${CYN}msfconsole -r $SESSION_DIR/s3rp_msf_setup.rc${NC} to exploit."
    echo -e "2. View ${CYN}${OUT_BASE}.html${NC} for visual recon report."
    echo -e "3. Review ${CYN}${SESSION_DIR}/exploits.txt${NC} for PoCs."
    echo -e "${WHT}===================================================${NC}"
}

# --- RUN ---
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}[!] ROOT REQUIRED.${NC}"
   exit 1
fi

check_system
banner
get_target
run_scan
generate_exploits
finalize
